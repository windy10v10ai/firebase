# AI 英雄推荐系统 - 分阶段实施计划 v2

## 概览

本文档将实施工作分为两个阶段：

- **Phase 1**: 快速实验验证（建立专有表，导入历史数据，训练并部署模型）
- **Phase 2**: 持续优化（模型调参、自动重训练、监控）

**关键策略**：先建专有 BigQuery 表并导入 GA4 历史数据，之后所有训练都用这一张表。

**详细任务清单**：见 [GITHUB_ISSUES.md](./GITHUB_ISSUES.md)

---

## Phase 1: 快速实验验证（2-3 周）

**目标**：建立专有数据表，导入历史数据，快速训练模型并验证方案可行性

### Phase 1.0: 数据基础设施（先决条件）

**关键策略**：先导入历史数据，立即可以开始训练，无需等待新数据收集。

- **Issue #1**: 创建 BigQuery 数据集和表结构（1 小时）
- **Issue #2**: 从 GA4 导入历史数据到专有表（2-3 小时）← **关键！**
- **Issue #3**: 验证历史数据质量和数量（0.5 小时）
- **Issue #4**: 实现 BigQueryService（持续数据写入，4 小时）
- **Issue #5**: 在 Analytics 服务中集成 BigQuery 写入（2 小时）
- **Issue #6**: 部署并验证持续数据写入（1 小时）

**为什么先导入历史数据？**
✅ 统一数据源，后续所有训练都用同一张表  
✅ 利用现有 GA4 历史数据，无需等待新数据收集  
✅ 数据导入一次性完成，训练时直接查询  
✅ 立即有 ≥50,000 场对局可训练

---

### Phase 1.1: 环境准备（第 1 周）

- **Issue #7**: 创建 Python 训练项目结构（2 小时）
- **Issue #8**: 实现数据加载器（2 小时）
- **Issue #9**: 实现特征工程模块（4 小时）

---

### Phase 1.2: 模型训练（第 2 周）

- **Issue #10**: 实现 XGBoost 训练脚本（6 小时）
- **Issue #11**: 首次模型训练和评估（4 小时）

**验收标准**：

- Top-1 准确率 > 2%（随机猜测为 0.77%）
- Top-3 准确率 > 5%

---

### Phase 1.3: 推理服务部署（第 3 周）

- **Issue #12**: 创建 FastAPI 推理服务（4 小时）
- **Issue #13**: 编写 Dockerfile 并本地测试（2 小时）
- **Issue #14**: 部署到 Cloud Run（4 小时）
- **Issue #15**: 游戏 Bot 集成推荐 API（4 小时）

---

### Phase 1.4: 灰度测试（持续 1 周）

- **Issue #16**: 灰度测试和效果评估（4 小时）

**验收标准**：

- 至少运行 100 场 AI 推荐对局
- 有胜率统计数据
- 决策：是否全量上线

---

### Phase 1 总结

**预计总工时**：47-50 小时 ≈ 6-7 个工作日  
**预计日历时间**：2-3 周（包括数据观察和调优）

**关键里程碑**：

- ✅ M1: 数据基础设施完成（Issue #1-#3，历史数据导入）
- ✅ M2: 持续数据收集上线（Issue #4-#6）
- ✅ M3: 训练环境就绪（Issue #7-#9，第 1 周）
- ✅ M4: 首个模型训练完成（Issue #10-#11，第 2 周）
- ✅ M5: 推理服务上线（Issue #12-#14，第 3 周）
- ✅ M6: 灰度测试完成并决策（Issue #15-#16，第 3-4 周）

---

## Phase 2: 持续优化（Phase 1 完成后，长期运行）

**目标**：模型优化和自动化重训练机制

⚠️ **注意**：数据基础设施已在 Phase 1.0 中完成，Phase 2 专注于模型和流程优化。

### Phase 2.1: 模型优化（持续）

- **Issue #17**: 模型调参优化（10 小时）

**验收标准**：

- 至少尝试 5 组不同参数
- 找到比 baseline 更好的配置

---

### Phase 2.2: 自动化（长期）

- **Issue #18**: 设置每周自动重训练（6 小时）
- **Issue #19**: 创建监控 Dashboard（4 小时）

**验收标准**：

- 每周自动训练成功
- Dashboard 可访问，数据每日更新
- 有告警机制

---

## 实施时间线

### 执行策略

```
周 | Phase 1                                  | Phase 2
---+------------------------------------------+-------------------------
准备 | #1-#3 (BigQuery建表+数据导入, 3.5-4.5h)  | -
1  | #4-#9 (持续写入+训练环境, 11h)            | -
2  | #10-#11 (训练+评估, 10h)                 | -
3  | #12-#15 (推理服务, 14h)                  | #17 (开始调参)
4  | #16 (灰度测试, 4h)                       | #18, #19 (自动化+监控)
5+ | 全量上线                                  | 持续优化
```

### 关键里程碑

- **准备阶段**: 建表并导入历史数据（3.5-4.5 小时）← **关键！**
- **Week 1**: Python 环境就绪，可以加载数据
- **Week 2**: 首个模型训练完成
- **Week 3**: 推理服务上线
- **Week 4**: 灰度测试并决策
- **Week 5+**: 全量上线 + 持续监控优化

---

## 总预计工时

- **Phase 1（核心）**: 47-50 小时
  - 数据基础设施：10.5-11.5 小时
  - 训练环境：8 小时
  - 模型训练：10 小时
  - 推理服务：14 小时
  - 灰度测试：4 小时
- **Phase 2（优化）**: 20 小时
  - 调参：10 小时
  - 自动化：6 小时
  - 监控：4 小时
- **总计**: 67-70 小时

**实际日历时间**：约**3 周**完成 Phase 1 核心功能，Phase 2 可以持续迭代。

---

## 风险与缓解

| 风险               | 影响             | 缓解措施                                     |
| ------------------ | ---------------- | -------------------------------------------- |
| 历史数据量不足     | 模型效果差       | 确认至少有 50k 对局后再开始训练              |
| 数据导入失败       | 阻塞所有后续工作 | 先 dry-run 验证，分批导入                    |
| 首次训练效果差     | 方案可行性受质疑 | 设定合理预期（Top-1 > 2%即可），强调迭代优化 |
| Cloud Run 冷启动慢 | 用户体验差       | 配置 min_instances=1                         |
| 模型过拟合         | 泛化能力差       | 交叉验证、正则化                             |

---

## 下一步

### 立即执行（Issue #1-#3）

1. **确认 GA4 Property ID**

   ```bash
   # 在BigQuery控制台查找analytics_开头的数据集
   # 格式：analytics_<property_id>
   ```

2. **创建 BigQuery 专有表**（Issue #1）

   - 复制 `BIGQUERY_SETUP.md` 中的建表 SQL
   - 在 BigQuery 控制台执行

3. **导入历史数据**（Issue #2）

   - 选择方式 A（SQL 直接导入）或方式 B（Python 脚本）
   - 先 dry-run 验证数据量
   - 确认 ≥ 50,000 场对局

4. **验证数据质量**（Issue #3）
   - 执行数据质量检查 SQL
   - 确认数据满足训练要求

**预计时间**：3.5-4.5 小时（完成后可以开始训练！）

### 后续步骤

详细任务描述请参考 [GITHUB_ISSUES.md](./GITHUB_ISSUES.md)

---

## 任务映射表

| V2 Issue | GitHub Issue | 说明                  |
| -------- | ------------ | --------------------- |
| #P1-0    | #1, #2, #3   | 拆分为 3 个细粒度任务 |
| #P1-0.1  | #4, #5, #6   | 拆分为 3 个细粒度任务 |
| #P1-1    | #7           | 对应                  |
| #P1-2    | #8           | 对应                  |
| #P1-3    | #9           | 对应                  |
| #P1-4    | #10          | 对应                  |
| #P1-5    | #11          | 对应                  |
| #P1-6    | #12          | 对应                  |
| #P1-7    | #13, #14     | 拆分为 2 个任务       |
| #P1-8    | #15          | 对应                  |
| #P1-9    | #16          | 对应                  |
| #P2-1    | #17          | 对应                  |
| #P2-2    | #18          | 对应                  |
| #P2-3    | #19          | 对应                  |

---

**版本**: v2.1（简化版，详细任务见 GITHUB_ISSUES.md）  
**更新日期**: 2026-01-14  
**状态**: 已确认游戏规则，可以开始实施  
**详细任务清单**: [GITHUB_ISSUES.md](./GITHUB_ISSUES.md)
